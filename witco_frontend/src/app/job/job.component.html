<div class="job-page">
    <div class="job-header">
        <div>
            <p class="job-eyebrow">Job Builder</p>
            <h1>Build a Delivery Job</h1>
            <p class="job-subtitle">Upload a PO or invoice, then complete customer and goods details in a guided flow.</p>
        </div>
        <div class="job-header__stats">
            <div class="stat-card">
                <span>Step 1</span>
                <strong>Customer</strong>
            </div>
            <div class="stat-card">
                <span>Step 2</span>
                <strong>Goods</strong>
            </div>
        </div>
    </div>
    <mat-card class="job-card">
        <div class="upload-panel">
        <div class="upload-box">
            <div class="upload-header">
                <h4>Auto-fill from PO / Invoice</h4>
                <span class="upload-hint">Drag & drop PDF or image (best effort)</span>
            </div>
            <div class="drop-zone" [class.drag-over]="isDragOver"
                 (click)="triggerBrowse()"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)">
                <div class="drop-text">
                    <mat-icon>cloud_upload</mat-icon>
                    <span>Drop file here or click to browse</span>
                </div>
                <span class="upload-file" *ngIf="documentFile">{{documentFile.name}}</span>
                <mat-progress-spinner *ngIf="isParsing" diameter="24" mode="indeterminate"></mat-progress-spinner>
                <input #docInput class="hidden-input" type="file" accept=".pdf,image/*"
                    (change)="onDocumentSelected($event)">
            </div>
            <div class="draft-panel" *ngIf="parsedDraft">
                <div class="draft-row">
                    <mat-checkbox [(ngModel)]="draftOptions.customer">Customer</mat-checkbox>
                    <div class="draft-value">
                        {{parsedDraft.customerName || '-'}} {{parsedDraft.customerCompany ? '(' + parsedDraft.customerCompany + ')' : ''}}
                    </div>
                </div>
                <div class="draft-row">
                    <mat-checkbox [(ngModel)]="draftOptions.contact">Contact</mat-checkbox>
                    <div class="draft-value">
                        {{parsedDraft.customerEmail || '-'}} {{parsedDraft.customerPhone || ''}}
                    </div>
                </div>
                <div class="draft-row">
                    <mat-checkbox [(ngModel)]="draftOptions.delivery">Delivery</mat-checkbox>
                    <div class="draft-value">
                        {{parsedDraft.deliveryAddress || '-'}}
                    </div>
                </div>
                <div class="draft-row">
                    <mat-checkbox [(ngModel)]="draftOptions.invoice">Invoice</mat-checkbox>
                    <div class="draft-value">
                        DO {{parsedDraft.invoiceNumber || '-'}} | PO {{parsedDraft.poNumber || '-'}}
                    </div>
                </div>
                <div class="draft-row">
                    <mat-checkbox [(ngModel)]="draftOptions.goods">Goods</mat-checkbox>
                    <div class="draft-value">
                        <span *ngIf="parsedDraft.goods?.length; else noGoods">
                            <span *ngFor="let item of parsedDraft.goods; let last = last">
                                {{item.goodsName}} ({{item.quantity}}){{last ? '' : ', '}}
                            </span>
                        </span>
                        <ng-template #noGoods>-</ng-template>
                    </div>
                </div>
                <div class="draft-actions">
                    <button mat-raised-button color="primary" type="button" (click)="applyDraft()">Apply Draft</button>
                    <button mat-button type="button" (click)="discardDraft()">Discard</button>
                </div>
            </div>
            <mat-chip-list *ngIf="parseWarnings.length">
                <mat-chip color="warn" selected *ngFor="let warning of parseWarnings">
                    {{warning}}
                </mat-chip>
            </mat-chip-list>
        </div>
    </div>
        <mat-horizontal-stepper #stepper class="job-stepper" linear>
        <mat-step [stepControl]="customerForm">
            <ng-template matStepLabel>Fill out customer Form</ng-template>
            <div class="main">
                <mat-card class="customer-card">
                    <div *ngIf="searchformdisplay" class="search-box">
                        <div class="search-input-box">
                            <input [(ngModel)]="searchTerm" placeholder="Search Existing Customer" #search class="search-input"> 
                            <mat-icon class="search-icon" color="primary">search</mat-icon>
                        </div>
                        <mat-list role="list" *ngIf="filteredItems.length != 0" class="search-list">
                            <mat-list-item role="listitem" *ngFor="let item of filteredItems" (click)="setForm(item)">
                                <div class="search-result">
                                    <div class="search-result__title">
                                        {{ item.firstName }} {{ item.lastName }} {{ item.companyName }}
                                    </div>
                                    <div class="search-result__meta" *ngIf="item.deliveryAddress || item.address">
                                        {{ item.deliveryAddress || item.address }}
                                    </div>
                                </div>
                            </mat-list-item>
                        </mat-list>
                    </div>
                    <mat-card-content>
                        <div class="section-title">Customer profile</div>
                        <div class="wrapper">
                            <form class="example-form" [formGroup]="customerForm" (ngSubmit)="onSubmit()">
                                <mat-card-content class="form-grid">
                                    <mat-form-field class="example-full-width">
                                        <input matInput formControlName="firstName" placeholder="First Name"
                                            autocomplete="off">

                                    </mat-form-field>
                                    <div class="field-error"
                                        *ngIf="customerForm.get('firstName').invalid && (customerForm.get('firstName').dirty || customerForm.get('firstName').touched)">
                                        <mat-error *ngIf=" customerForm.get('firstName').hasError('required')">
                                            First Name is Required!
                                        </mat-error>
                                        <mat-error *ngIf="customerForm.get('firstName').hasError('pattern')">
                                            First Name is invalid.
                                        </mat-error>
                                    </div>
                                    <mat-form-field class="example-full-width">
                                        <input matInput formControlName="lastName" placeholder="Last Name"
                                            autocomplete="off">
                                    </mat-form-field>
                                    <div class="field-error"
                                        *ngIf="customerForm.get('lastName').dirty || customerForm.get('lastName').touched">
                                        <mat-error *ngIf="customerForm.get('lastName').hasError('pattern')">
                                            Last Name is invalid.
                                        </mat-error>
                                    </div>
                                    <mat-form-field class="example-full-width">
                                        <input matInput formControlName="companyName" placeholder="Company Name"
                                            autocomplete="off">
                                    </mat-form-field>
                                    <mat-form-field class="example-full-width">
                                        <input matInput formControlName="email" placeholder="Email" autocomplete="off">
                                    </mat-form-field>
                                    <div class="field-error" *ngIf="customerForm.get('email').dirty || customerForm.get('email').touched">
                                        <mat-error *ngIf="customerForm.get('email').hasError('pattern')">
                                            Email is invalid.
                                        </mat-error>
                                    </div>
                                    <div class="phoneFild">
                                        <mat-form-field>
                                            <mat-label>Country code</mat-label>
                                            <mat-select formControlName="code">
                                                <mat-option value="+65">
                                                    +65
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <mat-form-field class="example-full-width">
                                            <input matInput formControlName="phone" class="phoneNumber"
                                            placeholder="Phone Number" autocomplete="off" min-length="8" max-length="8">
                                        </mat-form-field>
                                    </div>
                                    <div class="field-error"
                                        *ngIf="customerForm.get('phone').invalid && (customerForm.get('phone').dirty || customerForm.get('phone').touched)">
                                        <mat-error *ngIf="customerForm.get('phone').hasError('required')">
                                            Number Is Required!
                                        </mat-error>

                                        <mat-error *ngIf="customerForm.get('phone').hasError('pattern')">
                                            Phone number only contain 8 number
                                        </mat-error>
                                    </div>

                                    <mat-form-field class="example-full-width span-2">
                                        <input matInput formControlName="address" placeholder="Address" type="text"
                                            autocomplete="off">
                                    </mat-form-field>
                                    <mat-form-field class="example-full-width span-2">
                                        <input matInput formControlName="deliveryAddress" placeholder="Delivery Address"
                                            autocomplete="off">
                                    </mat-form-field>
                                    <div class="field-error"
                                        *ngIf="customerForm.get('deliveryAddress').invalid && (customerForm.get('deliveryAddress').dirty || customerForm.get('deliveryAddress').touched)">
                                        <mat-error *ngIf="customerForm.get('deliveryAddress').hasError('required')">
                                            Delivery Address is Required!
                                        </mat-error>
                                    </div>
                                    <mat-form-field class="example-full-width" *ngIf="false">
                                        <input matInput formControlName="userRole" placeholder="userRole" type="text"
                                            autocomplete="off">
                                    </mat-form-field>
                                </mat-card-content>
                                <div class="form-actions">
                                    <div class="actions-left">
                                        <button mat-stroked-button color="primary" type="submit"
                                            *ngIf="!searchCustomer" [disabled]="show ? customerForm?.invalid || !areFormControlsSame() : areFormControlsSame()">{{!searchCustomer? 'save' : 'update'}}</button>
                                    </div>
                                    <div class="actions-right">
                                        <button mat-raised-button color="primary" type="button" matStepperNext
                                            [disabled]="show ? !areFormControlsSame() || saveCustomerDetails  : changeInputBool ?  !areFormControlsSame() : !changetext">next</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>
        </mat-step>
        <mat-step [stepControl]="goodsForm">
            <ng-template matStepLabel>Fill out Goods Form</ng-template>
            <form class="example-form" [formGroup]="goodsForm" (ngSubmit)="onsubmitGood()">
                <mat-card-content>
                    <div class="section-title">Goods details</div>
                    <div class="form-grid">
                        <mat-form-field class="example-full-width">
                            <input matInput formControlName="inv_temp" placeholder="PO Number" autocomplete="off">
                        </mat-form-field>
                      
                        <mat-form-field class="example-full-width">
                            <input matInput formControlName="invoiceNumber" placeholder="DO Number" autocomplete="off">
                        </mat-form-field>
                        <div class="field-error"
                            *ngIf="goodsForm.get('invoiceNumber').invalid && (goodsForm.get('invoiceNumber').dirty || goodsForm.get('invoiceNumber').touched)">
                            <mat-error *ngIf="goodsForm.get('invoiceNumber').hasError('required')">
                                DO Number is Required!
                            </mat-error>
                        </div>
                        <mat-form-field class="example-full-width span-2">
                            <input matInput formControlName="zipcode" placeholder="Zip Code"
                                autocomplete="off">
                        </mat-form-field>
                        <div class="field-error"
                        *ngIf="goodsForm.get('zipcode').invalid && (goodsForm.get('zipcode').dirty || goodsForm.get('zipcode').touched)">

                        <mat-error *ngIf="goodsForm.get('zipcode').hasError('pattern')">
                            zipcode only contain 6 digit!
                        </mat-error>
                        </div>
                    </div>

                    <div class="goods-header">
                        <h3>Add Good</h3>
                        <button mat-raised-button color="primary" type="button" (click)="addGoods()">Add Goods</button>
                    </div>
                    <ng-container formArrayName="goods">
                        <ng-container *ngFor="let good of goods.controls;let i=index">
                            <div class="good-main-box">
                                <div [formGroupName]="i" class="goods-box">
                                    <mat-form-field class="example-full-width good-fild-1">
                                        <input matInput formControlName="goodsName" placeholder="Goods Name"
                                            autocomplete="off" [matAutocomplete]="inventoryAuto"
                                            (input)="onGoodsNameInput(i)">
                                    </mat-form-field>
                                    <mat-autocomplete #inventoryAuto="matAutocomplete">
                                        <mat-option *ngFor="let option of inventorySuggestions" [value]="option.name">
                                            <span>{{option.name}}</span>
                                            <span class="inventory-option-meta" *ngIf="option.category">
                                                ({{option.category}})
                                            </span>
                                        </mat-option>
                                        <mat-option *ngIf="inventoryLoading" disabled>
                                            Loading...
                                        </mat-option>
                                        <mat-option *ngIf="!inventoryLoading && inventorySuggestions.length === 0 && (good.get('goodsName').value || '').length >= 2" disabled>
                                            No matches
                                        </mat-option>
                                    </mat-autocomplete>

                                    <mat-form-field class="example-full-width good-fild-2">

                                        <input matInput formControlName="quantity" placeholder="Quantity"
                                            autocomplete="off" type="text">
                                            
                                        <mat-error *ngIf="good.get('quantity').hasError('pattern')">
                                                Invalid Quantity.
                                        </mat-error>
                                        <mat-error *ngIf="good.get('quantity').hasError('required')">
                                                Quantity is Required.
                                        </mat-error>
                                    </mat-form-field>
                                    
                                    <!-- <mat-form-field class="example-full-width good-fild">
                                        <input matInput formControlName="unitPrice" placeholder="Unit Price"
                                            autocomplete="off" type="text">
                                        <mat-error *ngIf="good.get('unitPrice').hasError('pattern')">
                                                Invalid Unit Price.
                                        </mat-error>
                                        <mat-error *ngIf="good.get('unitPrice').hasError('required')">
                                                Unit Price is Required.
                                        </mat-error>
                                    </mat-form-field> -->
                                </div>
                                <div class="delete">
                                    <mat-icon (click)="removeGood(i)">delete</mat-icon>
                                </div>
                            </div>
                        </ng-container>
                    </ng-container>
                </mat-card-content>
                <div class="form-actions">
                    <div class="actions-left">
                        <button mat-stroked-button type="button" matStepperPrevious>Back</button>
                    </div>
                    <div class="actions-right">
                        <button mat-raised-button color="primary" type="submit"
                            [disabled]="goodsForm?.invalid">submit</button>
                    </div>
                </div>
            </form>
        </mat-step>
        </mat-horizontal-stepper>
    </mat-card>
</div>
