<mat-card class="page-card">
  <div class="page-header">
    <div class="page-title-wrap">
      <h5 class="page-title">Dispatch Board</h5>
      <p class="page-subtitle">Drag jobs into driver lanes, optimize with AI, then dispatch in one click.</p>
    </div>
    <div class="page-actions">
      <button mat-flat-button color="primary" type="button" (click)="addJob()">
        <mat-icon>add_circle</mat-icon>
        Add Jobs
      </button>
    </div>
  </div>
  <div class="form-toolbar date-toolbar">
    <mat-form-field appearance="outline" (click)="inTimeCalendar.open()">
      <mat-label>From Date</mat-label>
      <input #fromInput matInput [matDatepicker]="inTimeCalendar" [max]="toDay" [(ngModel)]="fromDate" readonly>
      <mat-datepicker-toggle matSuffix [for]="inTimeCalendar"></mat-datepicker-toggle>
      <mat-datepicker #inTimeCalendar></mat-datepicker>
    </mat-form-field>
    <mat-form-field appearance="outline" (click)="outTimeCalendar.open()">
      <mat-label>To Date</mat-label>
      <input #toInput matInput [matDatepicker]="outTimeCalendar" [min]="fromDate" [max]="toDay" [(ngModel)]="toDate" readonly>
      <mat-datepicker-toggle matSuffix [for]="outTimeCalendar"></mat-datepicker-toggle>
      <mat-datepicker #outTimeCalendar></mat-datepicker>
    </mat-form-field>
    <div class="toolbar-actions toolbar-actions--date">
      <button class="search-btn" mat-flat-button color="warn" type="button" (click)="searchJobs()" [disabled]="!fromDate || !toDate">
        Search
      </button>
      <button class="reset-btn" mat-flat-button color="warn" type="button" (click)="resetFilters()">
        Reset
      </button>
    </div>
  </div>
</mat-card>

<mat-card class="page-card board-summary-card">
  <div class="board-summary">
    <div class="summary-item">
      <span class="summary-label">Total Pending</span>
      <strong class="summary-value">{{totalJobsCount}}</strong>
    </div>
    <div class="summary-item summary-item--warn">
      <span class="summary-label">Unassigned</span>
      <strong class="summary-value">{{unassignedCount}}</strong>
    </div>
    <div class="summary-item summary-item--accent">
      <span class="summary-label">Assigned</span>
      <strong class="summary-value">{{assignedJobsCount}}</strong>
    </div>
    <div class="summary-item">
      <span class="summary-label">Active Drivers</span>
      <strong class="summary-value">{{activeDriversCount}}</strong>
    </div>
    <div class="summary-item summary-item--ai" *ngIf="dispatchPlanId">
      <span class="summary-label">AI Draft</span>
      <strong class="summary-value">Saved</strong>
    </div>
  </div>
</mat-card>

<mat-card class="page-card board-toolbar-card">
  <div class="form-toolbar board-toolbar__controls">
    <mat-form-field appearance="outline">
      <mat-label>Depot Address (optional)</mat-label>
      <input matInput [(ngModel)]="depotAddress" placeholder="Use GPS or default depot">
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>ETA per stop (min)</mat-label>
      <input matInput type="number" [(ngModel)]="etaPerStopMinutes" min="5">
    </mat-form-field>
    <button mat-stroked-button color="primary" type="button" (click)="applyAiSuggestions()">
      AI Suggest
    </button>
    <mat-chip-list *ngIf="orsStatus?.ors">
      <mat-chip [color]="orsStatus.ors.enabled ? 'primary' : 'warn'" selected>
        ORS: {{orsStatus.ors.enabled ? 'Enabled' : 'Disabled'}}
      </mat-chip>
    </mat-chip-list>
    <mat-chip-list *ngIf="etaSource">
      <mat-chip [color]="etaSource === 'ors-directions' ? 'primary' : 'warn'" selected>
        ETA: {{etaSource === 'ors-directions' ? 'ORS' : 'Heuristic'}}
      </mat-chip>
    </mat-chip-list>
    <button mat-stroked-button type="button" (click)="clearAssignments()">
      Clear
    </button>
    <button mat-stroked-button color="warn" type="button" (click)="undoLastDispatch()">
      Undo Last Dispatch
    </button>
    <button mat-raised-button color="accent" type="button" (click)="dispatchAll()">
      Dispatch All
    </button>
  </div>
</mat-card>

<mat-card class="page-card board-card">
  <mat-card-content class="content-wrap board-content">
    <div class="board" cdkDropListGroup>
      <div class="column"
        *ngFor="let column of columns; trackBy: trackByColumn"
        [ngClass]="{
          'column--unassigned': column.id === 'unassigned',
          'column--active': column.id !== 'unassigned' && column.jobs.length > 0
        }">
        <div class="column-header">
          <h6>{{column.title}}</h6>
          <span class="count">{{column.jobs.length}} jobs</span>
          <span class="lane-type" *ngIf="column.id === 'unassigned'">Queue</span>
          <span class="lane-type lane-type--driver" *ngIf="column.id !== 'unassigned'">Driver Lane</span>
          <span class="driver-email" *ngIf="column.driverEmail">{{column.driverEmail}}</span>
        </div>
        <div class="column-body"
          cdkDropList
          [cdkDropListData]="column.jobs"
          (cdkDropListDropped)="drop($event, column)">
          <div class="column-empty" *ngIf="column.jobs.length === 0">
            <span *ngIf="column.id === 'unassigned'">No pending jobs in queue.</span>
            <span *ngIf="column.id !== 'unassigned'">Drag jobs here to assign this driver.</span>
          </div>
          <div class="job-card" *ngFor="let job of column.jobs; let i = index; trackBy: trackByJob" cdkDrag>
            <div class="job-top">
              <span class="job-seq" *ngIf="column.id !== 'unassigned'">#{{i + 1}}</span>
              <span class="job-invoice">DO {{job.invoiceNumber || job.inv_temp || job._id}}</span>
              <span class="job-date">{{job.createdAt | date : 'dd-MM-yyyy' : 'UTC'}}</span>
            </div>
            <div class="job-main">
              <div class="job-customer">{{job.customer_firstName}} {{job.customer_lastName}}</div>
              <div class="job-company">{{job.customer_companyName}}</div>
              <div class="job-address">{{job.deliveryAddress || job.customer_deliveryAddress || job.customer_address}}</div>
            </div>
            <div class="job-meta" *ngIf="job.etaTime">
              ETA {{job.etaTime | date : 'HH:mm'}} ({{job.etaMinutes}}m)
            </div>
            <div class="job-actions">
              <button mat-icon-button class="drag-handle" cdkDragHandle matTooltip="Drag to reorder">
                <mat-icon>drag_indicator</mat-icon>
              </button>
              <button mat-icon-button (click)="editJob(job._id)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteJob(job._id)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="columns.length && totalJobsCount === 0" class="no-data">
      <h2>No Jobs Are Available</h2>
    </div>
  </mat-card-content>

  <mat-paginator [length]="length" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions"
    aria-label="Select page" (page)="pageChange($event)">
  </mat-paginator>
</mat-card>
